<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Страница авторизации</title>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,600,700&display=swap" rel="stylesheet">

    <link href=/css/login.css type="text/css" rel=stylesheet>

    <script crossorigin src="/js/react.development.js"></script>
    <script crossorigin src="/js/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>


<body>
<div id="login-app"></div>
</body>


<script type="text/babel">

    class Login extends React.Component {
        constructor(props) {
            super(props);
            this.state = {permission: 0};
            this.login = {
                username: {
                    value: "",
                    handleChange: (event) => {
                        this.login.username.value = event.target.value;
                    }
                },
                password: {
                    value: "",
                    handleChange: (event) => {
                        this.login.password.value = event.target.value;
                    }
                },
                remember: {
                    value: false,
                    handleChange: () => {
                        if (this.login.remember.value == "true") {
                            this.login.remember.value = "false"
                        } else {
                            this.login.remember.value = "true";
                        }
                    }
                },
                email: {
                    value: "",
                    handleChange: (event) => {
                        this.login.email.value = event.target.value;
                    }
                },

                login: {
                    loginHandle: async () => {
                        if (
                            this.login.username.value &&
                            this.login.password.value.length >= 3
                        ) {

                            let response = await fetch('/login?' + "username=" + this.login.username.value + "&password=" +
                                this.login.password.value + "&remember-me=" + this.login.remember.value, {
                                method: 'POST',
                            })

                            if (response.ok) {
                                this.setState({permission: 0, error: 0});
                                document.getElementById("login-btn").style.display = "none";
                                document.getElementById("registration-btn").style.display = "none";

                                setTimeout(() => {
                                    let badLogin = window.location.protocol + '//' + window.location.hostname + ":8082/login?error";
                                    if (response.url != badLogin) {
                                        window.location.href = "/"
                                    } else {
                                        this.setState({permission: 0, error: 1});
                                    }
                                    document.getElementById("login-btn").style.display = "block";
                                    document.getElementById("registration-btn").style.display = "block";
                                }, 100);

                            }

                        } else {
                            this.setState({permission: 0, error: 1});
                        }
                    }
                },

                registration: {
                    registrationHandle: () => {
                        this.setState({permission: 1, error: 0});
                    }
                },

                addUser: {
                    handleChange: async () => {

                        var raw = JSON.stringify({
                            email: this.login.email.value,
                            password: this.login.password.value,
                            username: this.login.username.value
                        });

                        let response = await fetch("/addUser", {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: raw
                        })

                        if (response.ok) {
                            let textResponse = (await response.text()).valueOf()
                            if (textResponse == "Имя занято") {
                                alert("Имя занято")
                            } else if (textResponse == "Почта занята") {
                                alert("Почта занята")
                            } else {
                                alert("Пользователь добавлен")
                            }

                        }


                    }
                }
            };

            this.login.username.handleChange = this.login.username.handleChange.bind(this);
            this.login.password.handleChange = this.login.password.handleChange.bind(this);
            this.login.remember.handleChange = this.login.remember.handleChange.bind(this);
            this.login.email.handleChange = this.login.email.handleChange.bind(this);
            this.login.registration.registrationHandle = this.login.registration.registrationHandle.bind(this);
            this.login.addUser.handleChange = this.login.addUser.handleChange.bind(this);
        }

        render() {
            let errormessage = <p class="error-msg"> Invalid login attempt! </p>;
            let loginForm = (
                <div>
                    <input
                        type="text"
                        tabindex="1"
                        placeholder="Username"
                        onChange={this.login.username.handleChange}
                    />
                    <input
                        type="password"
                        tabindex="1"
                        placeholder="Password"
                        onChange={this.login.password.handleChange}
                    />
                    {this.state.error ? errormessage : null}
                    <input
                        id="abc"
                        name="remember"
                        value="true"
                        type="checkbox"
                        class="display-none"
                        onClick={this.login.remember.handleChange}
                    />
                    <label
                        for="abc"
                        class="label-block checkbox">
                        Remember me
                    </label>
                    <div
                        id="login-btn"
                        class="btn btn-login" onClick={this.login.login.loginHandle}>
                        Login
                    </div>
                    <div
                        id="registration-btn"
                        className="btn btn-registration" onClick={this.login.registration.registrationHandle}>
                        Registration
                    </div>
                </div>
            );

            let content = (
                <div>
                    <h2>Registration user</h2>
                    <input
                        type="text"
                        tabindex="2"
                        placeholder="Username"
                        onChange={this.login.username.handleChange}
                    />
                    <input
                        type="password"
                        tabindex="2"
                        placeholder="Password"
                        onChange={this.login.password.handleChange}
                    />
                    <input
                        type="text"
                        tabIndex="2"
                        placeholder="Email"
                        onChange={this.login.email.handleChange}
                    />

                    {this.state.error ? errormessage : null}
                    <div class="btn btn-login" onClick={this.login.addUser.handleChange}>
                        Зарегистрироваться
                    </div>
                </div>
            );

            return (
                <div className={`box ${this.state.permission ? "content" : "login"}`}>
                    {this.state.permission ? content : loginForm}
                </div>
            );
        }
    }

    class App extends React.Component {
        render() {
            return <Login/>;
        }
    }

    ReactDOM.render(<App/>, document.getElementById("login-app"));


</script>

</html>